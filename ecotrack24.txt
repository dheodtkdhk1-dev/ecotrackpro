<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EcotrackPro — 수질TMS 실시간 대시보드 (데모)</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --blue-1:#0f57a2;
  --blue-2:#1473c8;
  --muted:#6c757d;
  --bg:#f4f7fb;
  --card:#fff;
  --border:#e6eef7;
  --good:#28a745;
  --warn:#f0ad4e;
  --bad:#d9534f;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:"Noto Sans KR","Malgun Gothic",Arial,sans-serif;background:var(--bg);color:#122433;-webkit-font-smoothing:antialiased}

/* Header */
header{background:linear-gradient(90deg,var(--blue-1),var(--blue-2));color:#fff;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:44px;height:44px;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--blue-1);font-weight:900}
.title{font-weight:900;font-size:16px}
.header-controls{display:flex;align-items:center;gap:8px}

/* page container */
.wrap{max-width:1400px;margin:8px auto;padding:6px 10px 40px 10px}

/* --- Real-time summary row (smaller height so main shows) --- */
.summary-board{display:flex;gap:10px;margin-top:8px;margin-bottom:8px;align-items:stretch}
.summary-card{flex:1;background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px 10px;box-shadow:0 6px 18px rgba(15,79,148,0.03)}
.summary-card h4{margin:0;color:var(--muted);font-size:12px}
.summary-card .big{font-size:20px;font-weight:900;color:var(--blue-1);margin-top:6px}

/* --- Alerts row (reduced height) --- */
.alerts-row{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start}
.alerts-box{flex:1;background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px;min-height:60px;max-height:160px;overflow:auto}
.alerts-box h3{margin:0 0 6px 0;font-size:14px;color:var(--muted)}
.alert-item{padding:6px 0;border-bottom:1px dashed #eef3fa}
.alert-item:last-child{border-bottom:none}

/* pulse animation for new alerts */
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(33,150,243,0.2);} 70% { box-shadow: 0 0 0 8px rgba(33,150,243,0);} 100% { box-shadow: 0 0 0 0 rgba(33,150,243,0);} }
.pulse { animation: pulse 1s ease-out; }

/* main two columns (map left, right area) */
.main{display:grid;grid-template-columns:48% 52%;gap:10px}
@media(max-width:1100px){.main{grid-template-columns:1fr}}

/* left map card with site list under it */
/* set relative + overflow hidden so labels can't escape and cover adjacent panels */
.map-card{background:var(--card);border-radius:8px;padding:6px;border:1px solid #eaf2ff;min-height:560px;display:flex;flex-direction:column;gap:6px; position:relative; z-index:1}
.map-title{font-weight:800;color:var(--blue-1);margin-bottom:4px;font-size:14px}
/* background-image -> 내부 <img> 사용 (파일 누락 시 업로드로 대체 가능) */
.map-canvas{width:100%;height:380px;border-radius:8px;position:relative;overflow:hidden;padding:8px;border:1px solid #dff0ff;background:none;display:block}
#koreaMapImg{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:0; pointer-events:none; display:block; background:#fff; }
/* 업로드 버튼 스타일 */
#loadMapBtn{ display:none; position:absolute; left:12px; top:12px; z-index:6; padding:8px 12px; border-radius:8px; border:none; background:var(--blue-1); color:#fff; cursor:pointer; box-shadow:0 6px 18px rgba(15,79,148,0.12); }
#loadMapBtn:hover{ opacity:0.95; }

/* 라벨을 이미지 위에 보이게 (이미지 z-index 0, 라벨 z-index 3) */
.region-label{position:absolute;transform:translate(-50%,-50%);background:linear-gradient(180deg,#fff,#f1f8ff);color:var(--blue-2);padding:6px 10px;border-radius:18px;font-weight:800;font-size:12px;border:1px solid rgba(11,78,145,0.08);cursor:pointer;box-shadow:0 6px 18px rgba(15,79,148,0.06);z-index:3;user-select:none;max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;pointer-events:auto}
.region-label.dragging{opacity:0.85; box-shadow:0 10px 24px rgba(15,79,148,0.18); cursor:grabbing;}
.jeju-label{position:absolute;right:12px;bottom:12px;background:#fff;padding:6px 8px;border-radius:8px;font-weight:800;color:var(--blue-2);border:1px solid #e6eef7;z-index:3}

/* toolbar and hint */
.map-toolbar{position:absolute; right:12px; top:12px; z-index:8; display:flex; gap:8px}
.map-toolbar button{padding:6px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.94); color:var(--blue-1); font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(15,79,148,0.06)}
.map-toolbar button.active{background:var(--blue-1); color:#fff}
.map-edit-hint{position:absolute; left:12px; bottom:12px; padding:8px 10px; background:rgba(255,255,255,0.95); border-radius:8px; z-index:8; font-size:13px; color:var(--muted); box-shadow:0 6px 18px rgba(15,79,148,0.04)}

/* drop area hint */
.map-canvas.drop-active{ outline:3px dashed rgba(15,87,162,0.18); }

/* site list under map (slightly smaller) */
.site-list-panel{background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px;max-height:140px;overflow:auto; z-index:2}
.site-row{padding:6px;border-bottom:1px solid #f1f5fb;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.site-row:hover{background:#f7fbff}
.site-row .meta{font-size:13px;color:var(--muted)}
.site-row .right-val{font-weight:900;font-size:13px}

/* right area layout: top blue panel */
.right-area{display:flex;flex-direction:column;gap:10px; position:relative; z-index:2}
.site-select-box{background:#f1f6fb;border-radius:8px;padding:6px 8px;border:1px solid #e6eef7}
.site-select{width:100%;background:transparent;border:none;outline:none;font-weight:800;padding:8px 10px;border-radius:6px}

/* big blue header */
.blue-panel{background:linear-gradient(90deg,var(--blue-2),var(--blue-1));color:#fff;border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;gap:8px}
.blue-top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.site-title{font-size:16px;font-weight:900}
.blue-sub{display:flex;gap:6px;align-items:center;font-size:12px;flex-wrap:wrap}
.outlet-select{background:#fff;color:var(--blue-2);padding:6px 8px;border-radius:18px;border:none;font-weight:800}

/* content within blue panel */
.panel-content{display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap}
.left-stats-card{width:200px;background:#f8fbff;border:1px solid #eaf0ff;border-radius:8px;padding:8px}
.left-stats-card h4{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #e7f2ff}
.stat-row:last-child{border-bottom:none}
.stat-label{font-weight:800;color:#17324a}
.stat-value{font-weight:900;font-size:13px}

/* charts area */
.chart-area{flex:1;background:#fff;border-radius:8px;padding:6px;border:1px solid #eef6ff}
.chart-box{background:#fff;padding:6px;border-radius:8px;border:1px solid #eef6a!important;overflow:hidden}
.chart-box canvas{display:block;max-width:100%!important}

/* Actions (now embedded under alerts) -- make them compact */
.pre-action, .post-action{background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px;max-height:120px;overflow:auto}
.pre-action h4,.post-action h4{margin:0 0 6px 0;font-size:14px;color:var(--muted)}
.badge{display:inline-block;padding:4px 8px;border-radius:12px;font-weight:800;font-size:12px;color:#fff}
.badge.level1{background:#f7b500}
.badge.level2{background:#ff9800}
.badge.level3{background:#e53935}

/* post table style */
.post-table{width:100%;border-collapse:collapse;margin-top:6px}
.post-table th,.post-table td{padding:6px;border-bottom:1px solid #eef3fa;text-align:left}
.post-table th{background:#fbfdff;font-weight:800}

/* GIS & measure box */
.gis-area{margin-top:8px;display:grid;grid-template-columns:1fr 300px;gap:10px; position:relative; z-index:2}
@media(max-width:1100px){.gis-area{grid-template-columns:1fr}}
#gisMap{height:380px;border-radius:8px;border:1px solid var(--border); background:#fff}
.measure-box{background:#fff;border:1px solid #eef6ff;padding:10px;border-radius:8px;height:140px;overflow:hidden}

/* utility small */
.small-btn{padding:6px 10px;border-radius:6px;border:none;background:var(--blue-1);color:#fff;font-weight:800;cursor:pointer}
.link-btn{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:#fff;color:var(--blue-1);font-weight:800;cursor:pointer}

/* responsive tweaks */
@media(max-width:900px){
  .panel-content{flex-direction:column}
}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="32" height="32" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#7ed0ff"/><stop offset="1" stop-color="#0f57a2"/></linearGradient></defs>
          <path d="M32 6C32 6 20 24 20 36a12 12 0 0 0 24 0C44 24 32 6 32 6z" fill="url(#g)"/>
        </svg>
      </div>
      <div>
        <div class="title">EcotrackPro</div>
        <div class="subtitle" style="font-size:12px">수질TMS 실시간 대시보드 — 데모</div>
      </div>
    </div>

    <div class="header-controls">
      <div class="periods-inline" id="periodsHeader">
        <button data-period="daily" class="active">일 배출량</button>
        <button data-period="weekly">주간</button>
        <button data-period="quarter">분기</button>
        <button data-period="annual">연간</button>
      </div>

      <button class="violator-quick" id="violatorQuickBtn">위반사업장</button>
    </div>
  </div>

  <div style="font-size:12px;color:#fff;opacity:0.95">실시간 데모 — 수치는 샘플입니다</div>
</header>

<main class="wrap">
  <!-- Real-time summary board -->
  <div class="summary-board" aria-live="polite">
    <div class="summary-card">
      <h4>현재 강수량</h4>
      <div id="liveRain" class="big">0.0 mm/h</div>
    </div>
    <div class="summary-card">
      <h4>강우 등급</h4>
      <div id="liveGrade" class="big">관심</div>
    </div>
    <div class="summary-card">
      <h4>유역 총량 부하율</h4>
      <div id="liveLoad" class="big">0 %</div>
    </div>
    <div class="summary-card">
      <h4>기준 초과 사업장</h4>
      <div id="liveExceedCount" class="big">0 개소</div>
    </div>
  </div>

  <!-- Alerts + embedded pre/post (compact) -->
  <div class="alerts-row">
    <div class="alerts-box" id="alertsBox">
      <h3>실시간 경고 알림</h3>
      <div id="alertsList" style="color:#333;font-size:13px;line-height:1.4">
        - 현재 경고 없음
      </div>

      <!-- compacted 사전조치/사후관리 바로 아래에 배치 -->
      <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
        <div class="pre-action" id="preActionBox">
          <h4>사전 조치 (강우 예보 기반)</h4>
          <div id="preActionContent" style="font-size:13px">
            <div style="margin-bottom:6px">현재 강우 등급: <span id="preGradeBadge" class="badge level1">관심</span> <strong id="preRain">0.0 mm/h</strong></div>
            <div style="font-weight:800;margin-bottom:4px">등급별 대응 매뉴얼</div>
            <ul style="margin:0;padding-left:16px;font-size:13px;line-height:1.3">
              <li><strong>1등급 (관심)</strong>: 야적장 덮개 및 배수로 상태 확인</li>
              <li><strong>2등급 (주의)</strong>: 초기 우수 저류 시설 가동 준비</li>
              <li><strong>3등급 (경계)</strong>: 비상 대응팀 가동, 유관기관 보고 준비</li>
            </ul>
          </div>
        </div>

        <div class="post-action" id="postActionBox">
          <h4>사후 관리 (강우 종료 후)</h4>
          <div style="font-size:13px;color:var(--muted);margin-bottom:6px">허가배출기준을 초과한 사업장에는 '원인 분석 및 개선 계획서' 제출을 요청합니다.</div>
          <table class="post-table" id="postTable">
            <thead><tr><th>사업장</th><th>초과 항목</th><th>조치 현황</th></tr></thead>
            <tbody><tr><td>-</td><td>-</td><td>-</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right side: site select + quick outlet -->
    <div style="width:340px;display:flex;flex-direction:column;gap:8px">
      <div class="site-select-box">
        <select id="siteSelect" class="site-select"></select>
      </div>

      <div class="site-select-box">
        <select id="outletQuick" class="site-select">
          <option>옥외 배수구</option><option>야적장</option><option>사업장 경계</option><option>폐수 최종유출구</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Main area: left map + right blue panel -->
  <div class="main">
    <section class="map-card" aria-label="지역 선택 지도">
      <div class="map-title">지역 선택 지도</div>
      <div class="map-canvas" id="svgMap" title="지도에 이미지를 드래그하거나 업로드 버튼을 눌러 이미지를 대체할 수 있습니다.">
        <!-- PNG 이미지를 내부 img로 삽입 (파일명: korea_regions.png, HTML과 같은 폴더에 저장하면 자동 사용) -->
        <img id="koreaMapImg" src="korea_regions.png" alt="대한민국 행정구역 지도 (샘플)" onerror="handleMapError()" />

        <!-- upload + toolbar -->
        <div class="map-toolbar" id="mapToolbar">
          <button id="editLabelsBtn" title="라벨 이동/설정 모드 전환">라벨 이동</button>
          <button id="saveLayoutBtn" title="현재 라벨 위치 저장">저장</button>
          <button id="resetLayoutBtn" title="기본 위치로 복원">초기화</button>
        </div>
        <button id="loadMapBtn" type="button">지도 이미지 불러오기</button>
        <input id="mapFileInput" type="file" accept="image/*" style="display:none" />

        <!-- labels (data-default-left/data-default-top 포함) -->
        <div class="region-label" data-region="서울" data-default-left="30" data-default-top="18">서울</div>
        <div class="region-label" data-region="인천" data-default-left="24" data-default-top="22">인천</div>
        <div class="region-label" data-region="경기" data-default-left="33" data-default-top="26">경기</div>
        <div class="region-label" data-region="강원" data-default-left="54" data-default-top="10">강원</div>
        <div class="region-label" data-region="충북" data-default-left="48" data-default-top="30">충북</div>
        <div class="region-label" data-region="충남" data-default-left="34" data-default-top="40">충남</div>
        <div class="region-label" data-region="세종" data-default-left="38" data-default-top="38">세종</div>
        <div class="region-label" data-region="대전" data-default-left="41" data-default-top="40">대전</div>
        <div class="region-label" data-region="전북" data-default-left="18" data-default-top="56">전북</div>
        <div class="region-label" data-region="광주" data-default-left="14" data-default-top="64">광주</div>
        <div class="region-label" data-region="전남" data-default-left="10" data-default-top="72">전남</div>
        <div class="region-label" data-region="대구" data-default-left="60" data-default-top="56">대구</div>
        <div class="region-label" data-region="경북" data-default-left="66" data-default-top="44">경북</div>
        <div class="region-label" data-region="경남" data-default-left="62" data-default-top="70">경남</div>
        <div class="region-label" data-region="울산" data-default-left="74" data-default-top="65">울산</div>
        <div class="region-label" data-region="부산" data-default-left="76" data-default-top="78">부산</div>
        <div class="region-label" data-region="제주" data-default-left="88" data-default-top="88">제주</div>
      </div>

      <div class="site-list-panel" id="siteListPanel">
        <!-- populated by JS -->
      </div>
    </section>

    <div class="right-area">
      <div class="site-select-box" style="display:none">
        <select id="siteSelectRight" class="site-select"></select>
      </div>

      <div class="blue-panel">
        <div class="blue-top">
          <div>
            <div class="site-title" id="panelTitle">사업장 없음</div>
            <div class="blue-sub" id="blueSub">
              <div style="background:rgba(255,255,255,0.12);padding:6px 8px;border-radius:6px;">소재지: -</div>
              <div style="background:rgba(255,255,255,0.12);padding:6px 8px;border-radius:6px;">측정항목: TOC,SS,T-N,T-P</div>
              <div style="background:rgba(255,255,255,0.12);padding:6px 8px;border-radius:6px;">시설용량: - ㎥/일</div>
            </div>
          </div>
          <div>
            <select id="outletSelect" class="outlet-select"></select>
          </div>
        </div>

        <div class="panel-content">
          <div class="left-stats-card">
            <h4 id="periodRange">최근 측정</h4>
            <div class="stat-row"><div class="stat-label">옥외 배수구</div><div style="display:flex;align-items:center;gap:6px"><div class="stat-value" id="ssVal">-</div></div></div>
            <div class="stat-row"><div class="stat-label">야적장</div><div style="display:flex;align-items:center;gap:6px"><div class="stat-value" id="tocVal">-</div></div></div>
            <div class="stat-row"><div class="stat-label">사업장 경계</div><div style="display:flex;align-items:center;gap:6px"><div class="stat-value" id="tnVal">-</div></div></div>
            <div class="stat-row"><div class="stat-label">폐수 최종유출구</div><div style="display:flex;align-items:center;gap:6px"><div class="stat-value" id="tpVal">-</div></div></div>
          </div>

          <div class="chart-area">
            <div class="title">일 배출량 (샘플)</div>
            <div class="chart-box"><canvas id="barTop" height="160"></canvas></div>
            <div style="margin-top:8px" class="title">일 농도 (샘플)</div>
            <div class="chart-box"><canvas id="barBottom" height="120"></canvas></div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <div style="font-size:12px;color:#e4f0ff">※ 데모 수치 (실시간 시뮬레이션)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- GIS and measure box -->
  <section class="gis-area">
    <div style="background:#fff;border-radius:8px;padding:12px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900;color:var(--blue-1)">GIS 지도 (전체 사업장)</div>
        <div style="font-size:13px;color:var(--muted)">마커 클릭 → 상세</div>
      </div>
      <div id="gisMap" style="margin-top:12px"></div>
    </div>

    <div class="measure-box">
      <div style="font-weight:900;color:var(--blue-1)">측정시간 / 상태</div>
      <div id="measureTime" style="margin-top:8px;font-weight:800">-</div>
      <div style="margin-top:8px;color:var(--muted)">선택 사업장 또는 전체의 최신 측정 시간을 표시합니다.</div>
      <div style="margin-top:10px;font-weight:900">간단 통계</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1;background:#f7fbff;padding:8px;border-radius:8px;text-align:center">TOC 평균<br><div id="miniToc" style="font-weight:800">-</div></div>
        <div style="flex:1;background:#fff7f0;padding:8px;border-radius:8px;text-align:center">SS 평균<br><div id="miniSs" style="font-weight:800">-</div></div>
      </div>
    </div>
  </section>

</main>

<script>
/* Simulated realtime logic (keeps behavior from prior version) */
const THRESHOLDS = { SS:5.0, TOC:10.0, 'T-N':3.0, 'T-P':0.1 };
function rand(min,max,dec=3){ return +(Math.random()*(max-min)+min).toFixed(dec); }

/* Build demo sites */
const REGIONS = ['서울','부산','대구','인천','광주','대전','울산','경기','강원','충북','충남','전북','전남','경북','경남','세종','제주'];
const SITES = [];
const prefixes=['에코','그린','신우','동해','한솔','성진','바다','청정','환경','수처리','퍼시픽','하이'];
const industries=['폐수처리','화학','제지','도장','세탁','플랜트','폐기물','정수','가공','제조'];
REGIONS.forEach((r,ri)=>{
  for(let i=1;i<=8;i++){
    const name = `${r} ${prefixes[(i+ri)%prefixes.length]}${industries[(i*3)%industries.length]} ${i}`;
    const lat = 36 + (Math.random()-0.5)*4;
    const lng = 127 + (Math.random()-0.5)*5;
    const emission = { SS:rand(0,12), TOC:rand(0,22), 'T-N':rand(0,5), 'T-P':rand(0,0.3) };
    const capacity = Math.round(rand(200,1700,0));
    SITES.push({ id:`${r}-${i}`, name, region:r, lat, lng, addr:`${r}시 일대 (예시)`, items:['TOC','SS','T-N','T-P'], capacity, emission });
  }
});

/* DOM helper */
function $(id){ return document.getElementById(id); }

/* Populate UI */
function populateSiteList(){
  const panel = $('siteListPanel');
  panel.innerHTML = '';
  SITES.slice(0,60).forEach(s => {
    const div = document.createElement('div');
    div.className = 'site-row';
    div.innerHTML = `<div><div style="font-weight:900">${s.name}</div><div class="meta">${s.region} · ${s.addr}</div></div><div class="right-val">${s.emission.TOC.toFixed(1)}</div>`;
    div.addEventListener('click', ()=> {
      showSiteDetail(s.id);
      $('siteSelect').value = s.id;
      if(markers[s.id]) gisMap.setView(markers[s.id].getLatLng(), 11, { animate:true });
    });
    panel.appendChild(div);
  });
}
function populateSiteSelect(){
  const sel = $('siteSelect');
  sel.innerHTML = '<option value="">-- 사업장 선택 --</option>';
  SITES.forEach(s => {
    const opt = document.createElement('option'); opt.value = s.id; opt.textContent = s.name; sel.appendChild(opt);
  });
}
function populateOutletSelect(){
  const o = $('outletSelect'); o.innerHTML = '';
  const OUTLETS = ['옥외 배수구','야적장','사업장 경계','폐수 최종유출구'];
  OUTLETS.forEach(name => {
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name; o.appendChild(opt);
  });
}

/* Charts */
const barTop = new Chart($('barTop').getContext('2d'), {
  type:'bar',
  data:{ labels:['SS','TOC','T-N','T-P'], datasets:[{ data:[0,0,0,0], backgroundColor:['#4fc3f7','#ffb74d','#ffd54f','#a5d6a7'] }]},
  options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
});
const barBottom = new Chart($('barBottom').getContext('2d'), {
  type:'bar',
  data:{ labels:['SS','TOC','T-N','T-P'], datasets:[{ data:[0,0,0,0], backgroundColor:['#4db6ac','#ff8a65','#ffd54f','#66bb6a'] }]},
  options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
});

/* GIS */
const gisMap = L.map('gisMap',{preferCanvas:true}).setView([36.0,127.5],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(gisMap);
const markers = {};
function populateMapMarkers(){
  Object.values(markers).forEach(m => { try{ gisMap.removeLayer(m); }catch(e){} });
  Object.keys(markers).forEach(k=>delete markers[k]);
  SITES.forEach(s => {
    const ex = Object.keys(THRESHOLDS).some(k => s.emission[k] > THRESHOLDS[k]);
    const color = ex ? '#d9534f' : '#0f57a2';
    const m = L.circleMarker([s.lat, s.lng], { radius:5, fillColor: color, color:'#fff', weight:1, fillOpacity:1 }).addTo(gisMap);
    m.bindPopup(`<strong>${s.name}</strong><br>${s.region}<br>TOC ${s.emission.TOC.toFixed(2)}`);
    m.on('click', ()=> { showSiteDetail(s.id); $('siteSelect').value = s.id; });
    markers[s.id] = m;
  });
}

/* Live sim */
let liveRain = 0.0, liveLoadPercent = 0, liveGrade = '관심';
function computeGrade(rain){ if(rain >= 5) return '경계'; if(rain >= 2) return '주의'; return '관심'; }
function updateLiveMetrics(){
  if(Math.random() < 0.06) liveRain = +(Math.random()*35).toFixed(1);
  else liveRain = +(Math.max(0, liveRain + (Math.random()-0.5)*0.9)).toFixed(1);
  liveLoadPercent = Math.min(100, 20 + Math.round(Math.random()*60));
  liveGrade = computeGrade(liveRain);
  $('liveRain').textContent = `${liveRain} mm/h`;
  $('liveLoad').textContent = `${liveLoadPercent} %`;
  $('liveGrade').textContent = liveGrade;
  const badge = $('preGradeBadge'); badge.textContent = liveGrade;
  badge.className = 'badge ' + (liveGrade==='관심' ? 'level1' : (liveGrade==='주의' ? 'level2' : 'level3'));
  $('preRain').textContent = `${liveRain} mm/h`;
}

/* Alerts & post table (compact) */
let lastAlertsHtml = '';
function generateAlerts(){
  const alerts = [];
  SITES.forEach(s=>{ if(s.emission.TOC > THRESHOLDS.TOC) alerts.push({type:'기준 초과', text:`${s.name}, TOC 기준 초과.`}); if(Math.random()<0.008) alerts.push({type:'IoT 경고', text:`${s.name}, 야적장 덮개 미설치 감지.`}); });
  if(liveRain >= 5) alerts.unshift({type:'사전 대응', text:`강수량 ${liveRain} mm/h 도달 — 경계 대응 발령`});
  return alerts.slice(0,6);
}
function refreshAlerts(){
  const items = generateAlerts();
  const el = $('alertsList');
  const html = items.map(a => {
    return `<div class="alert-item">${a.type==='기준 초과'?'<strong style="color:#e53935">[기준 초과]</strong>':(a.type==='IoT 경고'?'<strong style="color:#ff9800">[IoT 경고]</strong>':'<strong style="color:#1976d2">[사전 대응]</strong>')} ${a.text}</div>`;
  }).join('');
  if(html !== lastAlertsHtml){
    el.innerHTML = html || '- 현재 경고 없음';
    el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
    lastAlertsHtml = html;
  }
}
function refreshPostTable(){
  const tbody = document.querySelector('#postTable tbody');
  tbody.innerHTML = '';
  const violators = SITES.filter(s => Object.keys(THRESHOLDS).some(k => s.emission[k] > THRESHOLDS[k]));
  if(violators.length === 0){ tbody.innerHTML = '<tr><td>-</td><td>-</td><td>-</td></tr>'; }
  else {
    violators.slice(0,8).forEach(v => {
      const ex = Object.keys(THRESHOLDS).filter(k => v.emission[k] > THRESHOLDS[k]).join(', ');
      const tr = document.createElement('tr');
      const btnId = `reqBtn-${v.id}`;
      tr.innerHTML = `<td>${v.name}</td><td>${ex}</td><td><button id="${btnId}" class="small-btn">개선 계획서 제출 요청</button></td>`;
      tbody.appendChild(tr);
      setTimeout(()=>{ const b = document.getElementById(btnId); if(b) b.addEventListener('click', ()=>{ b.textContent='요청 완료'; b.disabled=true; b.style.opacity=0.6; }); },0);
    });
  }
  $('liveExceedCount').textContent = `${violators.length} 개소`;
}

/* show detail */
function showSiteDetail(siteId){
  const site = SITES.find(x=>x.id===siteId); if(!site) return;
  $('panelTitle').textContent = site.name;
  const subs = $('blueSub').children;
  subs[0].textContent = `소재지: ${site.addr}`;
  subs[2].textContent = `시설용량: ${site.capacity.toLocaleString()} ㎥/일`;
  $('ssVal').textContent = site.emission.SS.toFixed(3);
  $('tocVal').textContent = site.emission.TOC.toFixed(3);
  $('tnVal').textContent = site.emission['T-N'].toFixed(3);
  $('tpVal').textContent = site.emission['T-P'].toFixed(3);
  barTop.data.datasets[0].data = [site.emission.SS, site.emission.TOC, site.emission['T-N'], site.emission['T-P']].map(v=>+v.toFixed(3));
  barTop.update();
  barBottom.data.datasets[0].data = [site.emission.SS, site.emission.TOC, site.emission['T-N'], site.emission['T-P']].map(v=>+v.toFixed(3));
  barBottom.update();
  $('measureTime').textContent = new Date().toLocaleString();
}

/* small drift and tick */
function driftSiteValues(){ SITES.forEach(s=>{ s.emission.SS = Math.max(0, +(s.emission.SS + (Math.random()-0.5)*0.4).toFixed(3)); s.emission.TOC = Math.max(0, +(s.emission.TOC + (Math.random()-0.5)*1.0).toFixed(3)); s.emission['T-N'] = Math.max(0, +(s.emission['T-N'] + (Math.random()-0.5)*0.2).toFixed(3)); s.emission['T-P'] = Math.max(0, +(s.emission['T-P'] + (Math.random()-0.5)*0.03).toFixed(3)); }); }

function tick(){
  updateLiveMetrics();
  driftSiteValues();
  // marker color update
  Object.keys(markers).forEach(id => {
    const s = SITES.find(x=>x.id===id);
    if(!s) return;
    const ex = Object.keys(THRESHOLDS).some(k=>s.emission[k]>THRESHOLDS[k]);
    markers[id].setStyle({ fillColor: ex ? '#d9534f' : '#0f57a2' });
  });
  refreshAlerts();
  refreshPostTable();
  const rows = document.querySelectorAll('.site-row');
  rows.forEach(row => {
    const name = row.querySelector('div > div').innerText;
    const s = SITES.find(x => x.name === name);
    if(s) row.querySelector('.right-val').textContent = s.emission.TOC.toFixed(1);
  });
  const sel = $('siteSelect').value;
  if(sel) showSiteDetail(sel);
}

/* Map image fallback + upload handling */
function handleMapError(){
  // 이미지 로드 실패 시 업로드 버튼 노출
  console.warn('korea_regions.png 로드 실패 — 로컬 파일을 업로드하여 대체하세요.');
  const btn = $('loadMapBtn');
  btn.style.display = 'inline-block';
  // bind file input
  const input = $('mapFileInput');
  btn.onclick = () => input.click();
  input.onchange = (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = $('koreaMapImg');
      img.src = e.target.result;
      btn.style.display = 'none';
      img.dispatchEvent(new Event('load'));
    };
    reader.readAsDataURL(file);
  };
  // enable drag & drop
  enableDragDropFallback();
}

function enableDragDropFallback(){
  const canvas = $('svgMap');
  const btn = $('loadMapBtn');
  const input = $('mapFileInput');

  function prevent(e){ e.preventDefault(); e.stopPropagation(); }
  ['dragenter','dragover','dragleave','drop'].forEach(evt => {
    canvas.addEventListener(evt, prevent);
  });

  canvas.addEventListener('dragover', () => {
    canvas.classList.add('drop-active');
  });
  canvas.addEventListener('dragleave', () => {
    canvas.classList.remove('drop-active');
  });
  canvas.addEventListener('drop', (e) => {
    canvas.classList.remove('drop-active');
    const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      alert('이미지 파일만 업로드 가능합니다.');
      return;
    }
    const reader = new FileReader();
    reader.onload = function(ev) {
      $('koreaMapImg').src = ev.target.result;
      btn.style.display = 'none';
      $('koreaMapImg').dispatchEvent(new Event('load'));
    };
    reader.readAsDataURL(file);
  });

  // 클릭 영역에서 업로드
  canvas.addEventListener('click', () => {
    const img = $('koreaMapImg');
    if (!img.complete || img.naturalWidth === 0) {
      input.click();
    }
  });

  input.onchange = (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      $('koreaMapImg').src = e.target.result;
      btn.style.display = 'none';
      $('koreaMapImg').dispatchEvent(new Event('load'));
    };
    reader.readAsDataURL(file);
  };
}

/* =========================
   Label positioning & editing
   - percent-based positions (left/top in %)
   - clamp to 0..100%
   - save per-image src to localStorage
   - drag / click-to-place / save / reset
   ========================= */

const LABELS_KEY_PREFIX = 'ecotrack_label_layout__'; // key + image.src

function percentWithinContainer(clientX, clientY, container) {
  const r = container.getBoundingClientRect();
  const x = Math.max(0, Math.min(r.width, clientX - r.left));
  const y = Math.max(0, Math.min(r.height, clientY - r.top));
  return { leftPct: (x / r.width) * 100, topPct: (y / r.height) * 100 };
}

function applyPositionsToLabels(positionsMap) {
  const canvas = $('svgMap');
  const labels = canvas.querySelectorAll('.region-label');
  labels.forEach(lbl => {
    const region = lbl.dataset.region;
    let leftPct = null, topPct = null;
    if (positionsMap && positionsMap[region]) {
      leftPct = positionsMap[region].left;
      topPct = positionsMap[region].top;
    } else {
      // fallback to defaults embedded in HTML
      leftPct = parseFloat(lbl.getAttribute('data-default-left') || lbl.style.left || '0');
      topPct = parseFloat(lbl.getAttribute('data-default-top') || lbl.style.top || '0');
    }
    lbl.style.left = leftPct + '%';
    lbl.style.top = topPct + '%';
    // persist current data attributes
    lbl.dataset.left = leftPct;
    lbl.dataset.top = topPct;
  });
}

function loadSavedLayoutForImage(imgSrc) {
  if (!imgSrc) return null;
  try {
    const raw = localStorage.getItem(LABELS_KEY_PREFIX + imgSrc);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) {
    console.warn('레이아웃 로드 실패', e);
    return null;
  }
}

function saveLayoutForImage(imgSrc, map) {
  if (!imgSrc) return;
  try {
    localStorage.setItem(LABELS_KEY_PREFIX + imgSrc, JSON.stringify(map));
    return true;
  } catch (e) {
    console.warn('레이아웃 저장 실패', e);
    return false;
  }
}

let editMode = false;
let movingLabel = null;
let clickToPlaceLabel = null;

function clampLabelToContainer(lbl) {
  if (!lbl) return;
  const left = Math.max(0, Math.min(100, parseFloat(lbl.dataset.left || lbl.style.left || '0')));
  const top  = Math.max(0, Math.min(100, parseFloat(lbl.dataset.top  || lbl.style.top  || '0')));
  lbl.style.left = left + '%';
  lbl.style.top  = top  + '%';
  lbl.dataset.left = left;
  lbl.dataset.top  = top;
}

function clampAllLabels() {
  const labels = document.querySelectorAll('#svgMap .region-label');
  labels.forEach(lbl => clampLabelToContainer(lbl));
}

function enableLabelInteractions() {
  const canvas = $('svgMap');
  const img = $('koreaMapImg');

  // ensure labels are set initially from defaults or saved layout
  function initPositionsForCurrentImage() {
    const key = img.src;
    const saved = loadSavedLayoutForImage(key);
    applyPositionsToLabels(saved);
    clampAllLabels();
  }

  initPositionsForCurrentImage();

  // update when image changes (upload)
  img.addEventListener('load', () => {
    const key = img.src;
    const saved = loadSavedLayoutForImage(key);
    applyPositionsToLabels(saved);
    clampAllLabels();
  });

  // pointer events: drag labels when editMode=true
  canvas.addEventListener('pointerdown', (ev) => {
    if (!editMode) return;
    const target = ev.target.closest('.region-label');
    if (target) {
      movingLabel = target;
      movingLabel.classList.add('dragging');
      canvas.setPointerCapture && canvas.setPointerCapture(ev.pointerId);
      ev.preventDefault();
    }
  });

  canvas.addEventListener('pointermove', (ev) => {
    if (!movingLabel) return;
    const pos = percentWithinContainer(ev.clientX, ev.clientY, canvas);
    movingLabel.style.left = pos.leftPct + '%';
    movingLabel.style.top = pos.topPct + '%';
    movingLabel.dataset.left = pos.leftPct;
    movingLabel.dataset.top = pos.topPct;
  });

  canvas.addEventListener('pointerup', (ev) => {
    if (!movingLabel) return;
    movingLabel.classList.remove('dragging');
    // 위치 보정(0~100%)
    clampLabelToContainer(movingLabel);
    movingLabel = null;
    try { canvas.releasePointerCapture && canvas.releasePointerCapture(ev.pointerId); } catch(e){}
  });

  // click-to-place: user clicks a label to "select" then clicks on map to place it
  canvas.addEventListener('click', (ev) => {
    if (!editMode) return;
    const target = ev.target.closest('.region-label');
    if (target) {
      // select this label for click-to-place
      clickToPlaceLabel = target;
      target.style.boxShadow = '0 12px 30px rgba(15,87,162,0.18)';
      setTimeout(()=>{ if(clickToPlaceLabel===target) target.style.boxShadow=''; }, 1800);
      return;
    }

    if (clickToPlaceLabel) {
      // place at clicked location
      const pos = percentWithinContainer(ev.clientX, ev.clientY, canvas);
      clickToPlaceLabel.style.left = pos.leftPct + '%';
      clickToPlaceLabel.style.top = pos.topPct + '%';
      clickToPlaceLabel.dataset.left = pos.leftPct;
      clickToPlaceLabel.dataset.top = pos.topPct;
      clampLabelToContainer(clickToPlaceLabel);
      clickToPlaceLabel = null;
    }
  });

  // keyboard: ESC to cancel selection
  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape') {
      clickToPlaceLabel = null;
      movingLabel = null;
      editMode = false;
      updateToolbarButtons();
    }
  });
}

function collectCurrentPositionsMap() {
  const canvas = $('svgMap');
  const labels = canvas.querySelectorAll('.region-label');
  const map = {};
  labels.forEach(lbl => {
    const region = lbl.dataset.region;
    const left = parseFloat(lbl.dataset.left || lbl.style.left || lbl.getAttribute('data-default-left') || 0);
    const top = parseFloat(lbl.dataset.top || lbl.style.top || lbl.getAttribute('data-default-top') || 0);
    map[region] = { left: left, top: top };
  });
  return map;
}

function resetLabelsToDefault() {
  const canvas = $('svgMap');
  const labels = canvas.querySelectorAll('.region-label');
  labels.forEach(lbl => {
    const defL = parseFloat(lbl.getAttribute('data-default-left') || '0');
    const defT = parseFloat(lbl.getAttribute('data-default-top') || '0');
    lbl.style.left = defL + '%';
    lbl.style.top = defT + '%';
    lbl.dataset.left = defL;
    lbl.dataset.top = defT;
  });
}

/* toolbar helpers */
function updateToolbarButtons() {
  const editBtn = $('editLabelsBtn');
  if (editMode) editBtn.classList.add('active'); else editBtn.classList.remove('active');
}

function initLabelEditor() {
  const editBtn = $('editLabelsBtn');
  const saveBtn = $('saveLayoutBtn');
  const resetBtn = $('resetLayoutBtn');
  const img = $('koreaMapImg');

  editBtn.addEventListener('click', () => {
    editMode = !editMode;
    updateToolbarButtons();
    if (editMode) {
      showMapHint('라벨 드래그 또는 라벨 클릭 → 이미지 클릭으로 위치 지정. 저장을 눌러 현재 이미지에 적용하세요.');
    } else {
      hideMapHint();
    }
  });

  saveBtn.addEventListener('click', () => {
    const key = img.src;
    const map = collectCurrentPositionsMap();
    const ok = saveLayoutForImage(key, map);
    if (ok) {
      showMapHint('저장되었습니다. 업로드된 동일 이미지에서 자동 적용됩니다.', 2500);
    } else {
      showMapHint('저장 실패(로컬 스토리지).', 2000);
    }
  });

  resetBtn.addEventListener('click', () => {
    if (!confirm('라벨을 초기 위치로 복원합니다. 저장을 원하면 "저장"을 눌러주세요. 계속하시겠습니까?')) return;
    resetLabelsToDefault();
    showMapHint('초기 위치로 복원되었습니다. 필요시 저장하세요.', 2200);
  });

  enableLabelInteractions();
}

let hintTimeout = null;
function showMapHint(text, timeout=4000) {
  hideMapHint();
  const canvas = $('svgMap');
  const div = document.createElement('div');
  div.className = 'map-edit-hint';
  div.id = 'mapEditHint';
  div.textContent = text;
  canvas.appendChild(div);
  if (timeout) hintTimeout = setTimeout(()=>{ hideMapHint(); }, timeout);
}
function hideMapHint() {
  clearTimeout(hintTimeout);
  const ex = document.getElementById('mapEditHint');
  if (ex && ex.parentNode) ex.parentNode.removeChild(ex);
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{

  populateSiteSelect();
  populateOutletSelect();
  populateSiteList();
  populateMapMarkers();

  initLabelEditor();

  // 이미지가 없을 때 업로드 버튼 자동표시 처리
  const img = $('koreaMapImg');
  setTimeout(() => {
    if (!img.complete || img.naturalWidth === 0) {
      handleMapError();
    } else {
      // 성공적으로 로드된 경우 업로드 버튼 숨김
      const btn = $('loadMapBtn');
      btn.style.display = 'none';
      // apply saved layout if available
      const saved = loadSavedLayoutForImage(img.src);
      applyPositionsToLabels(saved);
      clampAllLabels();
    }
  }, 200);

  if(SITES.length){
    $('siteSelect').value = SITES[0].id;
    showSiteDetail(SITES[0].id);
    if(markers[SITES[0].id]) gisMap.setView(markers[SITES[0].id].getLatLng(), 10);
  }

  $('siteSelect').addEventListener('change', (e)=>{ const id=e.target.value; if(id){ showSiteDetail(id); if(markers[id]) gisMap.setView(markers[id].getLatLng(),11); }});

  document.getElementById('violatorQuickBtn').addEventListener('click', ()=>{ $('alertsBox').scrollIntoView({behavior:'smooth', block:'center'}); });

  updateLiveMetrics(); refreshAlerts(); refreshPostTable();
  setInterval(tick, 3000);
});
</script>
</body>
</html>